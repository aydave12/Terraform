# Work with ELB via terraform

A terraform module for making ELB.


## Usage
----------------------
Import the module and retrieve with ```terraform get``` or ```terraform get --update```. Adding a module resource to your template, e.g. `main.tf`:

```
#
# MAINTAINER Vitaliy Natarov "vitaliy.natarov@yahoo.com"
#
terraform {
  required_version = "~> 1.0"
}

provider "aws" {
  region = "us-east-1"
}

module "elb" {
  source      = "../../modules/elb"
  name        = "TEST"
  environment = "stage"

  enable_elb             = true
  elb_name               = "my-elb-here"
  elb_security_groups    = []
  elb_subnets            = []
  elb_availability_zones = ["us-east-1a", "us-east-1b", "us-east-1c"]

  elb_access_logs = []
  elb_listener = [
    {
      instance_port     = "80"
      instance_protocol = "HTTP"
      lb_port           = "80"
      lb_protocol       = "HTTP"
    },
    #    {
    #        instance_port      = 443
    #        instance_protocol  = "https"
    #        lb_port            = 443
    #        lb_protocol        = "https"
    #        ssl_certificate_id = "${var.elb_certificate}"
    #    },
  ]
  elb_health_check = [
    {
      target              = "HTTP:80/"
      interval            = 30
      healthy_threshold   = 2
      unhealthy_threshold = 2
      timeout             = 5
    }
  ]

  # Enable AWS ELB app cookie stickiness policy
  enable_app_cookie_stickiness_policy = true
  app_cookie_stickiness_policy_stack = [
    {
      name        = "app-cookie-stickiness-policy"
      lb_port     = 80
      cookie_name = "MyAppCookie"
    }
  ]

  # Enable lb cookie stickiness policy
  enable_lb_cookie_stickiness_policy = true
  lb_cookie_stickiness_policy_stack = [
    {
      name                     = "lb-cookie-stickiness-policy"
      lb_port                  = 80
      cookie_expiration_period = 600
    }
  ]

  # Enable lb ssl negotiation policy
  enable_lb_ssl_negotiation_policy  = true
  lb_ssl_negotiation_policy_name    = "lb-ssl-negotiation-policy"
  lb_ssl_negotiation_policy_lb_port = 443
  lb_ssl_negotiation_policy_attribute = [
    {
      name  = "Protocol-TLSv1"
      value = false
    },
    {
      name  = "Protocol-TLSv1.1"
      value = false
    },
    {
      name  = "Protocol-TLSv1.2"
      value = true
    },
    {
      name  = "Server-Defined-Cipher-Order"
      value = true
    },
    {
      name  = "ECDHE-RSA-AES128-GCM-SHA256"
      value = true
    },
    {
      name  = "AES128-GCM-SHA256"
      value = true
    },
    {
      name  = "EDH-RSA-DES-CBC3-SHA"
      value = false
    }
  ]

  tags = tomap({
    "Environment"   = "dev",
    "Createdby"     = "Vitaliy Natarov",
    "Orchestration" = "Terraform"
  })
}
```

## Module Input Variables
----------------------
- `name` - Name to be used on all resources as prefix (`default = TEST`)
- `environment` - Environment for service (`default = STAGE`)
- `tags` - A list of tag blocks. (`default = {}`)
- `enable_elb` - Enable ELB usage (`default = False`)
- `elb_name` - The name of the ELB. By default generated by Terraform. (`default = ""`)
- `elb_availability_zones` - Availability zones for AWS ASG (`default = null`)
- `elb_security_groups` - A list of security group IDs to assign to the ELB. Only valid if creating an ELB within a VPC (`default = []`)
- `elb_subnets` - A list of subnet IDs to attach to the ELB (`default = null`)
- `elb_internal` - If true, ELB will be an internal ELB (`default = False`)
- `elb_cross_zone_load_balancing` - Enable cross-zone load balancing. Default: true (`default = True`)
- `elb_idle_timeout` - The time in seconds that the connection is allowed to be idle. Default: 60 (`default = 60`)
- `elb_connection_draining` - Boolean to enable connection draining. Default: false (`default = False`)
- `elb_connection_draining_timeout` - The time in seconds to allow for connections to drain. Default: 300 (`default = 300`)
- `elb_access_logs` - An access logs block. Uploads access logs to S3 bucket (`default = []`)
- `elb_listener` - A list of Listener block (`default = []`)
- `elb_health_check` -  Health check (`default = []`)
- `enable_elb_attachment` - Enable elb_attachment usage (`default = False`)
- `elb_attachment_instances` -  Instances ID to add them to ELB (`default = []`)
- `elb_attachment_elb_id` - ID of ELB (`default = ""`)
- `enable_app_cookie_stickiness_policy` - Enable app cookie stickiness policy usage (`default = False`)
- `app_cookie_stickiness_policy_stack` - Set stack settings for app cookie stickness policy (`default = []`)
- `enable_lb_cookie_stickiness_policy` - Enable lb cookie stickiness policy usage (`default = False`)
- `lb_cookie_stickiness_policy_stack` - Set stack settings for lb cookie stickness policy (`default = []`)
- `enable_proxy_protocol_policy` - Enable proxy protocol policy usage (`default = False`)
- `proxy_protocol_policy_load_balancer` - The name of the ELB. (`default = ""`)
- `proxy_protocol_policy_instance_ports` - (Required) Instance ID to place in the ELB pool. (`default = null`)
- `enable_lb_ssl_negotiation_policy` - Enable lb ssl negotiation policy (`default = False`)
- `lb_ssl_negotiation_policy_name` - The name of the SSL negotiation policy. (`default = ""`)
- `lb_ssl_negotiation_policy_load_balancer` - The load balancer to which the policy should be attached. (`default = ""`)
- `lb_ssl_negotiation_policy_lb_port` - (Required) The load balancer port to which the policy should be applied. This must be an active listener on the load balancer. (`default = null`)
- `lb_ssl_negotiation_policy_attribute` - (Optional) An SSL Negotiation policy attribute (`default = []`)
- `enable_load_balancer_policy` - Enable load balancer policy usage (`default = False`)
- `load_balancer_policy_load_balancer_name` - (Required) The load balancer on which the policy is defined. (`default = ""`)
- `load_balancer_policy_policy_name` - The name of the load balancer policy. (`default = ""`)
- `load_balancer_policy_policy_type_name` - (Required) The policy type. (`default = null`)
- `load_balancer_policy_policy_attribute` - (Optional) Policy attribute to apply to the policy. (`default = []`)
- `enable_load_balancer_backend_server_policy` - Enable load balancer backend server policy usage (`default = False`)
- `load_balancer_backend_server_policy_load_balancer_name` - The load balancer to attach the policy to. (`default = ""`)
- `load_balancer_backend_server_policy_instance_port` - (Required) The instance port to apply the policy to. (`default = null`)
- `load_balancer_backend_server_policy_policy_names` - (Required) List of Policy Names to apply to the backend server. (`default = []`)
- `enable_load_balancer_listener_policy` - Enable load balancer listener policy (`default = False`)
- `load_balancer_listener_policy_load_balancer_name` - The load balancer to attach the policy to. (`default = ""`)
- `load_balancer_listener_policy_load_balancer_port` - (Required) The load balancer listener port to apply the policy to. (`default = null`)
- `load_balancer_listener_policy_policy_names` - (Required) List of Policy Names to apply to the backend server. (`default = []`)

## Module Output Variables
----------------------
- `elb_id` - The ID of the ELB
- `elb_arn` - The ARN of the ELB
- `elb_name` - The name of the ELB
- `elb_dns_name` - The DNS name of the ELB
- `elb_instances` - The list of instances in the ELB
- `elb_source_security_group_id` - The ID of the security group that you can use as part of your inbound rules for your load balancer's back-end application instances
- `elb_source_security_group` - The name of the security group that you can use as part of your inbound rules for your load balancer's back-end application instances. Use this for Classic or Default VPC only.
- `elb_zone_id` - The canonical hosted zone ID of the ELB (to be used in a Route 53 Alias record)
- `elb_attachment_id` - The ID of the ELB attachmnet
- `app_cookie_stickiness_policy_id` - The ID of the policy.
- `app_cookie_stickiness_policy_name` - The name of the stickiness policy.
- `app_cookie_stickiness_policy_load_balancer` - The name of load balancer to which the policy is attached.
- `app_cookie_stickiness_policy_lb_port` - The load balancer port to which the policy is applied.
- `app_cookie_stickiness_policy_cookie_name` - The application cookie whose lifetime the ELB's cookie should follow.
- `lb_cookie_stickiness_policy_id` - The ID of the policy.
- `lb_cookie_stickiness_policy_name` - The name of the stickiness policy.
- `lb_cookie_stickiness_policy_load_balancer` - The load balancer to which the policy is attached.
- `lb_cookie_stickiness_policy_lb_port` - The load balancer port to which the policy is applied.
- `lb_cookie_stickiness_policy_cookie_expiration_period` - The time period after which the session cookie is considered stale, expressed in seconds.
- `lb_ssl_negotiation_policy_id` - The ID of the policy.
- `lb_ssl_negotiation_policy_name` - The name of the stickiness policy.
- `lb_ssl_negotiation_policy_load_balancer` - The load balancer to which the policy is attached.
- `lb_ssl_negotiation_policy_lb_port` - The load balancer port to which the policy is applied.
- `lb_ssl_negotiation_policy_attribute` - The SSL Negotiation policy attributes.
- `proxy_protocol_policy_id` - The ID of the ELB attachmnet
- `load_balancer_policy_id` - The ID of the load balancer policy
- `load_balancer_policy_policy_name` - The name of the stickiness policy.
- `load_balancer_policy_policy_type_name` - The policy type of the policy.
- `load_balancer_policy_load_balancer_name` - The load balancer on which the policy is defined.
- `load_balancer_backend_server_policy_id` - The ID of the policy.
- `load_balancer_backend_server_policy_load_balancer_name` - The load balancer on which the policy is defined.
- `load_balancer_backend_server_policy_instance_port` - The backend port the policies are applied to
- `load_balancer_listener_policy_id` - The ID of the policy.
- `load_balancer_listener_policy_load_balancer_name` - The load balancer on which the policy is defined.
- `load_balancer_listener_policy_load_balancer_port` - The load balancer listener port the policies are applied to


## Authors

Created and maintained by [Vitaliy Natarov](https://github.com/SebastianUA). An email: [vitaliy.natarov@yahoo.com](vitaliy.natarov@yahoo.com).

## License

Apache 2 Licensed. See [LICENSE](https://github.com/SebastianUA/terraform/blob/master/LICENSE) for full details.
